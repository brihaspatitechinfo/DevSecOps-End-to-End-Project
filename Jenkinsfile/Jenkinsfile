pipeline {
    agent any

    environment {
        PATH = "/opt/sonar-scanner/bin:$PATH"
        TERRAFORM_DIR = "terraform/"
    }

    stages {

        stage('Test Vault') {
            steps {
                withCredentials([
                    string(credentialsId: 'VAULT_ADDR', variable: 'VAULT_ADDR'),
                    string(credentialsId: 'VAULT_TOKEN', variable: 'VAULT_TOKEN')
                ]) {
                    sh '''
                    echo "Testing Vault Connection..."
                    export VAULT_ADDR="${VAULT_ADDR}"
                    export VAULT_TOKEN="${VAULT_TOKEN}"

                    vault read -format=json aws/creds/dev-role > aws_creds.json || { echo "Vault read failed"; exit 1; }
                    jq -r '.data.access_key' aws_creds.json > access_key.txt
                    jq -r '.data.secret_key' aws_creds.json > secret_key.txt
                    '''
                }
            }
        }

        stage('Run Node.js Tests') {
            steps {
                dir('src') {
                    sh '''
                    echo "Running Node.js tests..."
                    npm install || { echo "npm install failed"; exit 1; }
                    '''
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                        echo "Running SonarQube Analysis..."
                        sonar-scanner \
                            -Dsonar.projectKey=Project \
                            -Dsonar.sources=src \
                            -Dsonar.host.url=http://54.167.12.16:9000/ \
                            -Dsonar.login=sqa_1b4f3fa82cee6f3cad14282cd857512b1459bda0 | tee sonar-report.txt
                        '''
                    }
                }
            }
        }

        stage('Snyk Security Scan') {
            steps {
                dir('src') {
                    sh '''
                    echo "Running Snyk Security Scan..."
                    snyk test --json > snyk-results.json || echo "Snyk scan completed with warnings."
                    '''
                }
                archiveArtifacts artifacts: 'src/snyk-results.json', allowEmptyArchive: true
            }
        }

        stage('TFScan') {
            steps {
                dir('terraform') {
                    sh '''
                    echo "Running TFScan..."
                    tfsec . > tfsec-results.json || { echo "TFSec scan failed"; exit 1; }
                    '''
                }
                archiveArtifacts artifacts: 'terraform/tfsec-results.json', allowEmptyArchive: true
            }
        }

        stage('Terraform init & Plan') {
            steps {
                dir('terraform') {
                    sh '''
                    echo "Initializing Terraform..."
                    terraform init || { echo "Terraform init failed"; exit 1; }

                    echo "Planning Terraform changes..."
                    terraform plan -out=tfplan -var="aws_access_key=$(cat ../access_key.txt)" -var="aws_secret_key=$(cat ../secret_key.txt)"
